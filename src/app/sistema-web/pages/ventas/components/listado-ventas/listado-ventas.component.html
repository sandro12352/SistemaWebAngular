

<!-- FILTROS -->
  <div class="card mb-3">
    <div class="card-body">
      <form class="row g-2 align-items-end">
        <div class="col-sm-12 col-md-4">
          <label class="form-label small">Buscar (Codigo Venta / cliente)</label>
          <input type="text" class="form-control" [(ngModel)]="filtro.q" name="q" (ngModelChange)="aplicarFiltros()" placeholder="Ej: 0001, Juan Pérez">
        </div>

        <div class="col-sm-6 col-md-2">
          <label class="form-label small">Desde</label>
          <input type="date" class="form-control" [(ngModel)]="filtro.desde" (ngModelChange)="aplicarFiltros()" name="desde" >
        </div>

        <div class="col-sm-6 col-md-2">
          <label class="form-label small">Hasta</label>
          <input type="date" class="form-control" [(ngModel)]="filtro.hasta" (ngModelChange)="aplicarFiltros()" name="hasta" > 
        </div>

        <div class="col-sm-6 col-md-2">
          <label class="form-label small">Estado</label>
          <select class="form-select" [(ngModel)]="filtro.estado" name="estado" (change)="aplicarFiltros()">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="enviado">Enviado</option>
            <option value="pagado">Pagado</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>

        <div class="col-2">
          <label class="form-label samll">Usuario</label>
          <select class="form-select" [(ngModel)]="filtro.usuario"  name="usuario" (change)="aplicarFiltros()">
            <option value="">Todos</option>
            <ng-container *ngFor="let usuario of usuarios">
              <option *ngIf="usuario.rol === 'ventas'">
                {{ usuario.trabajador.nombre }}
              </option>
            </ng-container>
          </select>
        </div>

        <div class="col-sm-6 col-md-2 text-end">
          <button type="button" class="btn btn-outline-secondary w-100" (click)="limpiarFiltros()">Limpiar</button>
        </div>
      </form>
    </div>
  </div>

  
<!-- RESUMEN -->
<div class="row mb-3" *ngIf="mostrarResumen">
  <div class="col-sm-6 col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <small class="text-muted">Ventas mostradas</small>
        <h5>{{ ventasFiltradas!.length || 0 }}</h5>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <small class="text-muted">Total (S/)</small>
        <h5>{{ totalMostrado() | number:'1.2-2' }}</h5>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <small class="text-muted">Total pagado (S/)</small>
        <h5>{{ totalPagado() | number:'1.2-2' }}</h5>
      </div>
    </div>
  </div>
</div>




<!-- TABLA DE VENTAS -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 text-center">
          <thead class="table-light">
            <tr>
              <th>Cod Venta</th>
              <th>Usuario</th>
              <th>Canal</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Contacto</th>
              <th >Total (S/)</th>
              <th>Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let venta of ventasPaginadas(); let i = index">
              <td>{{ venta.venta_id }}</td>
              <td>{{venta.usuario?.trabajador?.nombre}} {{venta.usuario?.trabajador?.apellidos}}</td>
              <td>{{venta.canal_venta}}</td>
              <td>{{ venta.fecha_venta| date:'dd/MM/yyyy' }}</td>
              <td>{{ venta.cliente!.nombre }}  {{venta.cliente?.apellidos}}</td>
              <td>{{venta.cliente!.telefono}}</td>
              <td >{{ venta.total | number:'1.2-2' }}</td>
              <td>
                <span class="badge"
                      [ngClass]="{
                        'bg-warning text-dark': venta.estado === 'pendiente',
                        'bg-success': venta.estado === 'pagado',
                        'bg-dark':venta.estado ==='enviado',
                        'bg-danger': venta.estado === 'cancelado'
                      }">
                  {{ venta.estado }}
                </span>
              </td>
             <td class="text-center">
              <button class="btn btn-sm btn-outline-primary me-1" (click)="verDetalle(venta)">
              <i class="bi bi-eye"></i> Ver
              </button>
              <button class="btn btn-sm btn-outline-success me-1" data-bs-toggle="modal" data-bs-target="#modalMedioPago"
                  *ngIf="venta.estado === 'enviado'"  
                  (click)="recibirPago(venta)" >
                <i class="bi bi-cash-stack"></i> Pagado
              </button>
              <button 
                *ngIf="venta.estado === 'pagado'" 
                class="btn btn-sm btn-success me-1" 
                disabled>
                <i class="bi bi-cash-stack"></i> Pagado
              </button>
              <button 
  *ngIf="venta.estado === 'pendiente' || venta.estado === 'cancelado'" 
  class="btn btn-sm btn-outline-dark me-1" 
  (click)="marcarEnviado(venta)"
  [disabled]="venta.estado === 'cancelado'">
  <i class="bi bi-truck"></i> Enviado
            </button>

             <!-- Botón Anular -->
<button 
  class="btn btn-sm btn-outline-danger me-1"
  (click)="anularVenta(venta)"
  [disabled]="venta.estado === 'pagado' || venta.estado === 'cancelado'">
  <i class="bi bi-x-circle"></i> Anular
</button>

            </td>


            <tr *ngIf="ventasFiltradas?.length === 0">
              <td colspan="7" class="text-center py-4">
                No hay ventas para los filtros seleccionados.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- PAGINACIÓN SIMPLE -->
      <div class="d-flex justify-content-between align-items-center p-3">
        <div>
          <small class="text-muted">Mostrando {{ ventasPaginadas().length }} de {{ ventasFiltradas!.length || 0 }} ventas</small>
        </div>
        <nav aria-label="Paginación">
          <ul class="pagination mb-0">
            <li class="page-item" [class.disabled]="pagina === 1">
              <a class="page-link" (click)="cambiarPagina(pagina - 1)">Anterior</a>
            </li>
            <li class="page-item" *ngFor="let p of paginasArray()" [class.active]="p === pagina">
              <a class="page-link" (click)="cambiarPagina(p)">{{ p }}</a>
            </li>
            <li class="page-item" [class.disabled]="pagina === totalPaginas()">
              <a class="page-link" (click)="cambiarPagina(pagina + 1)">Siguiente</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>


















<!-- MODAL DETALLE VENTA -->
<div class="modal fade" id="modalDetalleVenta" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle de Venta #{{ ventaSeleccionada?.venta_id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="ventaSeleccionada; else sinDetalle">
          
          <!-- Contenedor flex para separar datos y clave ticket -->
          <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap">

            <!-- Datos básicos de la venta -->
            <div>
              <p><strong>Cliente:</strong> {{ ventaSeleccionada.cliente?.nombre }} {{ventaSeleccionada.cliente?.apellidos}}</p>
              <p><strong>Fecha:</strong> {{ ventaSeleccionada.fecha_venta| date:'dd/MM/yyyy HH:mm' }}</p>
              <p><strong>Estado:</strong> {{ ventaSeleccionada.estado }}</p>
            </div>
            <div>
              <p><strong>Dni:</strong> {{ ventaSeleccionada.cliente?.dni }}</p>
               <p><strong>Dirección:</strong> {{ ventaSeleccionada.cliente?.direccion }}</p>
              <p><strong>Departamento:</strong> {{ ventaSeleccionada.cliente?.departamento }}</p>
            </div>

            <!-- Controles para clave ticket y botón enviado -->
            <div class="text-end" style="width: 150px;">
              <input type="text" id="claveTicket" [disabled]="ventaSeleccionada.estado==='pagado' || ventaSeleccionada.estado==='enviado'
              || ventaSeleccionada.estado==='cancelado'" [(ngModel)]="ventaSeleccionada.clave" class="form-control mb-2" placeholder="Clave Ticket">
            </div>

          </div>

          <hr>

          <h6>Detalles</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Producto</th>
                  <th class="text-end">Precio</th>
                  <th class="text-center">Cantidad</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let it of ventaSeleccionada.detalle_venta">
                  <td>{{ it.producto?.nombre }}</td>
                  <td class="text-end">S/.{{ it.precio_vendido | number:'1.2-2' }}</td>
                  <td class="text-center">{{ it.cantidad }}</td>
                  <td class="text-end">S/.{{ (it.precio_vendido * it.cantidad) | number:'1.2-2' }}</td>
                </tr>
              </tbody>
              <tr>
                <th colspan="3" class="text-end">Total</th>
                <th class="text-end">S/.{{ ventaSeleccionada.total | number:'1.2-2' }}</th>
              </tr>
            </table>
          </div>
         
          <strong *ngIf="ventaSeleccionada">Notas:</strong>
          <div class="form-floating mb-3">
              <textarea class="form-control" [(ngModel)]="ventaSeleccionada.comentario" [disabled]="ventaSeleccionada.estado ==='pagado'
              || ventaSeleccionada.estado==='cancelado'" placeholder="Agregar un comentario" id="floatingTextarea2" style="height: 100px">{{ ventaSeleccionada.comentario }}</textarea>
              <label for="floatingTextarea2">Agrege un comentario:</label>
          </div>
          
        </div>

        <ng-template #sinDetalle>
          <p class="text-center text-muted">Selecciona una venta para ver su detalle.</p>
        </ng-template>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button class="btn btn-primary" data-bs-dismiss="modal" (click)="GuardarVenta(ventaSeleccionada!)">Guardar</button>
      </div>
    </div>
  </div>
</div>


 <div class="modal fade" id="modalMedioPago" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Medio de Pago del Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="list-group">
          <button 
            *ngFor="let medio of mediosPago" 
            class="list-group-item list-group-item-action"
            (click)="recibirPago(ventaSeleccionada!,medio)"
            data-bs-dismiss="modal">
            {{ medio }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>