<div class="container mt-4">
  <h2 class="text-primary"><i class="bi bi-bag-check text-dark"></i> Registrar Venta</h2>

  <!-- BUSCAR CLIENTE POR DNI -->
  <div class="row g-3 align-items-end">
  <!-- Input para buscar por DNI -->
  <div class="col-md-4">
    <label for="dni" class="form-label">Buscar cliente por DNI:</label>
    <input
      type="text"
      id="dni"
      class="form-control"
      [(ngModel)]="dniCliente"
      name="dniCliente"
      class="form-control  shadow-sm"
      placeholder="Ingrese DNI"
    />
  </div>

  <!-- Botón de búsqueda -->
  <div class="col-md-2">
    <button class="btn btn-primary w-100 " 
    style="font-weight: 600; letter-spacing: 0.03em; border-radius: 0.375rem; box-shadow: 0 2px 6px rgba(13,110,253,0.3); transition: box-shadow 0.2s ease;" (click)="buscarCliente()"
    >Buscar</button>
  </div>

  <!-- Botón para registrar cliente si no existe -->
  <div class="col-md-3">
    <button
      class="btn btn-outline-secondary w-100"
      data-bs-toggle="modal"
      data-bs-target="#modalCliente"
    >
      Registrar cliente
    </button>
  </div>
</div>
 <!-- Mensaje si no se encuentra el cliente -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" *ngIf="mostrarToast">
  <div class="toast align-items-center border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-warning">
      <strong class="me-auto text-success">
        <i class="bi bi-exclamation-triangle text-dark"></i> Alerta
      </strong>
    </div>
    <div class="toast-body">
      {{ mensajeErrorDni }}
    </div>
  </div>
</div>



<!-- Datos del cliente encontrados -->
<div class="row mt-4">
  <!-- Datos del cliente -->
  <div class="col-md-12">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-dark text-white">
        <strong>Datos del Cliente</strong>
      </div>
      <div class="card-body">
        <p><strong>Nombre:</strong> {{ cliente?.nombre }} {{ cliente?.apellidos }}</p>
        <p><strong>DNI:</strong> {{ cliente?.dni }}</p>
        <p><strong>Email:</strong> {{ cliente?.email }}</p>
        <p><strong>Teléfono:</strong> {{ cliente?.telefono }}</p>
        <p><strong>Dirección:</strong> {{ cliente?.direccion }}</p>
      </div>
    </div>
  </div>
    

  
</div>
<!-- Selección de productos -->
<div class="col-md-12 mt-4">
  <h2 class="text-primary"><i class="bi bi-shop text-dark"></i> Agrega Productos</h2>
  <!-- Tipo de Pago -->
  <div class="row">
    <!-- Producto -->
    <div class="mb-3 col-md-6">
      <label class="form-label">Producto:</label>
      <select class="form-select mb-3" [(ngModel)]="productoSeleccionadoId" name="productoSeleccionadoId">
        <option *ngFor="let p of productos" [value]="p.producto_id">
          {{ p.nombre }} - S/ {{ p.valor_venta }}
        </option>
      </select>
    </div>

    <!-- Canal de Venta -->
    <div class="mb-3 col-md-3">
      <label class="form-label">Canal de Venta:</label>
      <select class="form-select" [(ngModel)]="canalVentaSeleccionado" name="canalVentaSeleccionado">
        <option value="">Seleccione un canal</option>
        <option value="shopify">Shopify</option>
        <option value="whatsApp">Whatsapp</option>
        <option value="referido">Referido</option>
      </select>
    </div>
  </div>

  <!-- Precio de venta y Cantidad -->
  <div class="row mb-3">
    <!-- Precio de Venta -->
    <div class="col-6 col-md-2">
      <label class="form-label">Precio de Venta (S/):</label>
      <input 
        type="number" 
        step="0.01" 
        class="form-control" 
        [(ngModel)]="precioVentaSeleccionado" 
        name="precioVentaSeleccionado" 
        placeholder="Ej: 70.00"
        [min]="1"
      />
    </div>

    <!-- Cantidad -->
    <div class="col-6 col-md-2">
      <label class="form-label">Cantidad:</label>
      <input 
        type="number" 
        class="form-control" 
        [(ngModel)]="cantidadSeleccionada" 
        name="cantidad" 
        [max]="stockDisponible" 
        [min]="1" 
      />
      <small class="text-muted">Stock: {{ stockDisponible }}</small>
    </div>
  </div>

 

  <!-- Botón agregar -->
  <div class="mb-3">
    <button class="btn btn-primary" (click)="agregarProducto()">Agregar</button>
  </div>
</div>


  <hr />
  <!-- LISTA DE PRODUCTOS AGREGADOS -->
<table class="table table-striped mt-3" *ngIf="productosVenta.length > 0">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Cantidad</th>
      <th>Precio Unitario</th>
      <th>Subtotal</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let p of productosVenta; let i = index">
      <td>{{ p.nombre }}</td>
      <td>{{ p.cantidad }}</td>
      <td>S/ {{ p.valor_venta }}</td>
      <td>S/ {{ p.valor_venta! * p.cantidad }}</td>
      <td><button class="btn btn-danger btn-sm" (click)="quitarProducto(i)">Quitar</button></td>
    </tr>
  </tbody>
</table>

<!-- Comentario general de la venta -->
<div class="mb-3 form-floating">
  
   <textarea class="form-control" id="comentarioVenta" name="comentarioVenta" rows="3" [(ngModel)]="comentarioVenta" placeholder="Ingrese detalles adicionales sobre esta venta..."  style="height: 100px"></textarea>
   <label for="comentarioVenta">Comentario de la venta:</label>
</div>

  <!-- TOTAL -->
  <div class="d-flex justify-content-between align-items-center my-3">
    <h4>Total: S/ {{ calcularTotal() }}</h4>
    <button class="btn btn-warning" [disabled]="!cliente || productosVenta.length === 0 || !canalVentaSeleccionado " (click)="registrarVenta()">Registrar Venta</button>
  </div>
  
</div>








<!-- Modal de carga -->
   <div class="modal fade" #modalCarga id="modalCarga" tabindex="-1" aria-labelledby="CargaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4 text-center p-4">
      <div class="mb-3">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
      </div>
      <h5 class="fw-bold text-primary">Procesando venta</h5>
      <p class="text-muted mb-0" >Por favor, espera un momento...</p>
    </div>
  </div>
</div>


<!-- Modal de Éxito -->
<div class="modal fade" id="modalExito" #modalExito tabindex="-1" aria-labelledby="ExitoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-body text-center p-5">
        <!-- Icono circular -->
        <div class="rounded-circle bg-success bg-opacity-10 d-inline-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
          <i class="bi bi-check-circle-fill text-success fs-1"></i>
        </div>
        
        <!-- Título -->
        <h4 class="fw-bold text-success mb-2">¡Venta guardada!</h4>
        
        <!-- Descripción -->
        <p class="text-muted mb-4">La información de la venta se registró exitosamente.</p>
        
        <!-- Botón -->
        <button class="btn btn-success px-4 py-2 rounded-pill" data-bs-dismiss="modal">
          Aceptar
        </button>
      </div>
    </div>
  </div>
</div>  


<!-- MODAL REGISTRAR CLIENTE -->
<div class="modal fade"  id="modalCliente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form [formGroup]="registrarClienteForm" (ngSubmit)="guardarCliente()" class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title">Registrar Cliente</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body">
    
    <div class="mb-2">
      <label>DNI</label>
      <input type="text" class="form-control" formControlName="dni" />
      <small class="text-danger" *ngIf="registrarClienteForm.get('dni')?.invalid && registrarClienteForm.get('dni')?.touched">
        El DNI es obligatorio y debe tener al menos 8 dígitos.
      </small>
    </div>

    <div class="mb-2">
      <label>Nombres</label>
      <input type="text" class="form-control" formControlName="nombre" />
      <small class="text-danger" *ngIf="registrarClienteForm.get('nombre')?.invalid && registrarClienteForm.get('nombre')?.touched">
        El nombre es obligatorio
      </small>
    </div>

    <div class="mb-2">
      <label>Apellidos</label>
      <input type="text" class="form-control" formControlName="apellidos" />
      <small class="text-danger" *ngIf="registrarClienteForm.get('apellidos')?.invalid && registrarClienteForm.get('apellidos')?.touched">
        Los apellidos son obligatorios.
      </small>
    </div>

    <div class="mb-2">
      <label>Teléfono</label>
      <input type="text" class="form-control" formControlName="telefono" />
      <small class="text-danger" *ngIf="registrarClienteForm.get('telefono')?.invalid && registrarClienteForm.get('telefono')?.touched">
        El teléfono es obligatorio  y debe tener al menos 9 dígitos..
      </small>
    </div>

    <div class="mb-2">
      <label>Email</label>
      <input type="email" class="form-control" formControlName="email" />
      <small class="text-danger" *ngIf="registrarClienteForm.get('email')?.invalid && registrarClienteForm.get('email')?.touched">
        El correo no es válido.
      </small>
    </div>

    <div class="mb-2">
      <label>Dirección</label>
      <input type="text" class="form-control" formControlName="direccion" />
      <small class="text-danger" *ngIf="registrarClienteForm.get('direccion')?.invalid && registrarClienteForm.get('direccion')?.touched">
        La dirección es obligatoria.
      </small>
    </div>
     <div *ngIf="mensajeError" class="alert alert-danger text-center" role="alert">
      {{ mensajeError }}
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
    <button type="submit" class="btn btn-success" [disabled]="registrarClienteForm.invalid">Guardar Cliente</button>
  </div>
    </form>
</div>
</div>




